<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Bio Signal Visualizer</title>
	<link rel="stylesheet" href="index.css">
	<!-- Load in the d3 library -->
	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
	<main class="container">
		<header>
			<h1>Bio Signal Visualizer</h1>
			<h5>version <span id="version-number"></span></h5>
		</header>
		<div class="main-content">
			<div id="drag-n-drop-section">
				<h1>Click or Drag and Drop CSV file to start</h1>
				<input type="file" id="drag-n-drop-file-input" accept=".csv" hidden>
			</div>
			<!-- The Modal -->
			<div id="errorModal" class="modal">
				<!-- Modal content -->
				<div class="modal-content">
					<div class="modal-header">
						<p id="modal-header-text"></p>
						<span class="close" id="closeErrorModal">&times;</span>
					</div>
					<div class="modal-body" id="modal-body-text"></div>
					<div class="modal-footer">
						<!-- <h3>Modal Footer</h3> -->
					</div>
				</div>
			</div>

			<div id="visualizationWindow">

			</div>
		</div>
		<footer>Copyright Parsons School of Design &copy; 2020</footer>
	</main>
</body>
<script>
	const modal = document.querySelector('#errorModal');
	const fileUploadDialog = document.querySelector('#drag-n-drop-file-input');
	let fileSelected = false;

	window.addEventListener('click'), (event) => {
		if (event.target === modal)
			modal.style.display = 'none';
		// file dialog event on clicking anywhere on screen
		if (!fileSelected) {
			fileUploadDialog.click();
		}
	}

	document.querySelector('#closeErrorModal').addEventListener('click', () => {
		modal.style.display = 'none';
	});

	// handle files using file dialog function
	fileUploadDialog.addEventListener('change', handleFiles, false);

	function handleFiles() {
		const f = this.files[0]; /* now you can work with the file list */
		document.querySelector('#drag-n-drop-section').style.display = 'none';
		loadVisualization(f.path);
		fileSelected = true;
	}

	document.addEventListener('drop', (event) => {
		event.preventDefault();
		event.stopPropagation();

		for (const f of event.dataTransfer.files) {
			// Using the path attribute to get absolute file path 
			console.log(f);
			if (f.type === 'text/csv') {
				document.querySelector('#drag-n-drop-section').style.display = 'none';
				loadVisualization(f.path);
				fileSelected = true;
			} else {
				// if not csv file display modal
				document.querySelector('#modal-header-text').innerHTML = 'Invalid file type';
				document.querySelector('#modal-body-text').innerHTML = '<p>Please select a .csv file</p>';
				modal.style.display = 'block';
				fileSelected = false;
			}
		}
	});

	document.addEventListener('dragover', (e) => {
		e.preventDefault();
		e.stopPropagation();
	});

	function loadVisualization(filePath) {
		let margin = {
			top: 140,
			right: 80,
			bottom: 100,
			left: 80
		};
		let width = window.innerWidth - margin.left - margin.right; // Use the window's width 
		let height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

		let axisText = {
			x: 'x-axis',
			y: 'y-axis'
		}

		d3.csv(filePath, function (data) {
			data.forEach(function (d) {
				d.iteration = +d.iteration;
				d.value = +d.value;
			});
			let dataset = data;

			// 5. X scale will be iteration count
			let xScale = d3.scaleLinear()
				.domain(d3.extent(dataset, d => d.iteration)) // input
				.range([0, width]); // output

			// 6. Y scale will be value
			let yScale = d3.scaleLinear()
				.domain(d3.extent(dataset, d => d.value)) // input 
				.range([height, 0]); // output 

			// 7. d3's line generator
			let line = d3.line()
				.x(function (d, i) {
					return xScale(d.iteration);
				}) // set the x values for the line generator
				.y(function (d) {
					return yScale(d.value);
				}) // set the y values for the line generator 
				.curve(d3.curveMonotoneX) // apply smoothing to the line

			// 1. Add the SVG to the page and employ #2
			let svg = d3.select('#visualizationWindow').append('svg')
				.attr('width', width + margin.left + margin.right)
				.attr('height', height + margin.top + margin.bottom)
				.append('g')
				.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

			// 3. Call the x axis in a group tag
			svg.append('g')
				.style('font', '14px times')
				.attr('class', 'x axis')
				.attr('transform', 'translate(1,' + height + ')')
				.call(d3.axisBottom(xScale)); // Create an axis component with d3.axisBottom

			svg.append('text')
				.attr('transform', 'translate(' + (width / 2) + ' ,' + (height + margin.top / 3) + ')')
				.style('text-anchor', 'middle')
				.attr('font-size', '16px')
				.text(axisText.x);

			// 4. Call the y axis in a group tag
			svg.append('g')
				.style('font', '14px times')
				.attr('class', 'y axis')
				.attr('transform', 'translate(1,0)')
				.attr('font-size', '30px')
				.call(d3.axisLeft(yScale)); // Create an axis component with d3.axisLeft

			svg.append('text')
				.attr('transform', 'rotate(-90)')
				.attr('y', 0 - margin.left * 3 / 4)
				.attr('x', 0 - ((height) / 2))
				.attr('dy', '1em')
				.attr('font-size', '16px')
				.style('text-anchor', 'middle')
				.text(axisText.y);

			// 9. Append the path, bind the data, and call the line generator 
			svg.append('path')
				.attr('font-size', '30px')
				.datum(dataset) // 10. Binds data to the line 
				.attr('class', 'line') // Assign a class for styling 
				.attr('d', line); // 11. Calls the line generator 
		});
	}

</script>

</html>
